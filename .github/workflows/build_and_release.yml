name: Build and Release Executable

# This workflow is triggered on a 'push' event
# specifically when a tag matching the pattern 'v*.*.*' is created.
# This ensures that a new executable is built and released only for new versions.
on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build_sign_release:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      #####################################################################################
      ## --- BUILD --- (Using PyInstaller) ################################################
      #####################################################################################      
      - name: ðŸ Set up Python 3.13
        # Sets up the Python environment on the runner.
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: ðŸ“¦ Install Poetry and Build Dependencies
        # A single step to install poetry, export dependencies from the lock file,
        # and install them along with PyInstaller.
        run: |
          pip install poetry
          poetry self add poetry-plugin-export
          poetry export -f requirements.txt --output requirements.txt --without-hashes
          pip install -r requirements.txt

      - name: ðŸ” Create PAT file for PyInstaller
        # Create a file named 'GAT_PAT' containing the GitHub Token.
        # This file is bundled into the executable by 'git_audit.spec'.
        run: |
          echo "${{ secrets.GAT_PAT }}" > GAT_PAT
        shell: bash

      - name: ðŸ—ï¸ Build the executable with PyInstaller
        run: pyinstaller build/git_audit.spec

      #####################################################################################
      # --- SIGN --- (Using DigiCert Software Trust Manager) ##############################
      #####################################################################################
      - name: ðŸ” Code signing with DigiCert Software Trust Manager
        uses: digicert/ssm-code-signing@v1.1.1
        with:
          force-download-tools: true

      - name: Set up certificate 
        run: | 
          echo "${{ secrets.SM_CLIENT_CERT_FILE_B64 }}" | base64 --decode > /d/ .p12 
        shell: bash 

      - name: Set variables 
        id: variables 
        run: | 
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT 
          echo "SM_HOST=${{ secrets.SM_HOST }}" >> "$GITHUB_ENV" 
          echo "SM_API_KEY=${{ secrets.SM_API_KEY }}" >> "$GITHUB_ENV" 
          echo "SM_CLIENT_CERT_FILE=D:\\Certificate_pkcs12.p12" >> "$GITHUB_ENV" 
          echo "SM_CLIENT_CERT_PASSWORD=${{ secrets.SM_CLIENT_CERT_PASSWORD }}" >> "$GITHUB_ENV" 
        shell: bash
      
      - name: ðŸ” Sign the executable using keypair alias
        run: |
          smctl sign --keypair-alias key_1368373973 --input dist/ukb_git_audit_tool.exe

      #####################################################################################
      # --- RELEASE --- (Using GitHub Releases) ###########################################
      #####################################################################################

      - name: ðŸ—‘ï¸ Clean up PAT file
        # Remove the temporary file after PyInstaller has bundled it.
        run: rm GAT_PAT
        shell: bash

      - name: ðŸ·ï¸ Get the release tag name
        id: get_version
        run: echo "TAG=$(echo ${{ github.ref }} | sed 's/refs\/tags\///g')" >> $GITHUB_OUTPUT
        shell: bash

      - name: ðŸ“¤ Create GitHub Release and Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          # Sets the release tag name and the human-readable release title.
          tag_name: ${{ steps.get_version.outputs.TAG }}
          name: Release ${{ steps.get_version.outputs.TAG }}
          body: |
            ## Automated Release Notes
            - A new version of the git-auditor executable has been built and attached.
            - This release corresponds to the tag ${{ steps.get_version.outputs.TAG }}.
          # Specifies which files to upload as release assets.
          files: |
            dist/ukb_git_audit_tool_signed.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
